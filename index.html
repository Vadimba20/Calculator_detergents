<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор экономии моющих средств</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f9f9f9; }
    h1 { color:#2c7be5; }
    section { background:#fff; padding:15px; margin-bottom:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#2c7be5; color:#fff; }
    .btn { background:#2c7be5; color:#fff; padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
    .btn:hover { background:#1a5ecb; }
    canvas { max-width:100%; margin-top:20px; }
  </style>
</head>
<body>

<h1>Калькулятор экономии</h1>

<section>
  <h2>Общие параметры</h2>
  <label>Загрузка машины (кг): <input id="machineLoad" type="number" value="10"></label>
  <label>Тариф электроэнергии (₽/кВт·ч): <input id="energyTariff" type="number" value="6"></label>
  <label>Рабочих часов в день: <input id="workHours" type="number" value="9"></label>
</section>

<section>
  <h2>Текущие моющие средства</h2>
  <table id="currentTable">
    <thead>
      <tr>
        <th>Название</th>
        <th>Цена (₽)</th>
        <th>Вес (кг)</th>
        <th>Дозировка (г/мл)</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="btn" onclick="addRow('currentTable')">+ Добавить средство</button>
</section>

<section>
  <h2>Наши новые средства</h2>
  <label>Температура программы (°C): <input id="newTemp" type="number" value="60"></label>
  <label>Время программы (мин): <input id="newTime" type="number" value="45"></label>
  <table id="newTable">
    <thead>
      <tr>
        <th>Название</th>
        <th>Цена (₽)</th>
        <th>Вес (кг)</th>
        <th>Дозировка (г/мл)</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="btn" onclick="addRow('newTable')">+ Добавить средство</button>
</section>

<section>
  <h2>Результаты</h2>
  <div id="results"></div>
  <canvas id="chartCompare"></canvas>
  <button class="btn" onclick="exportPdf()">Экспорт в PDF</button>
</section>

<script>
let state = {current:[], new:[], machineLoad:10, energyTariff:6, workHours:9, newTemp:60, newTime:45};

function $(id){ return document.getElementById(id); }

function addRow(tableId){
  const tbody = $(tableId).querySelector('tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input></td>
    <td><input type="number" value="0"></td>
    <td><input type="number" value="1"></td>
    <td><input type="number" value="0"></td>
    <td><button onclick="this.parentElement.parentElement.remove()">x</button></td>
  `;
  tbody.appendChild(tr);
}

function collectData(){
  state.machineLoad = +$('machineLoad').value;
  state.energyTariff = +$('energyTariff').value;
  state.workHours = +$('workHours').value;
  state.newTemp = +$('newTemp').value;
  state.newTime = +$('newTime').value;

  function tableToArr(tableId){
    return Array.from($(tableId).querySelectorAll('tbody tr')).map(r=>{
      let i=r.querySelectorAll('input');
      return {name:i[0].value, price:+i[1].value, weight:+i[2].value, dose:+i[3].value};
    });
  }
  state.current = tableToArr('currentTable');
  state.new = tableToArr('newTable');
}

function costPerKg(arr){ return arr.reduce((s,p)=>s + (p.price * p.dose / p.weight || 0),0); }

function energyCostPerKg(temp, time, tariff, load){
  let energy = 0.05*temp + 0.1*(time/60);
  return (energy*tariff)/load;
}

function runsPerDay(time, hours){ return Math.floor(hours*60/time); }

function money(n){ return (n||0).toFixed(2)+' ₽'; }

let chart;
function update(){
  collectData();
  let oldChem=costPerKg(state.current);
  let newChem=costPerKg(state.new);
  let oldEnergy=energyCostPerKg(state.newTemp,state.newTime+15,state.energyTariff,state.machineLoad);
  let newEnergy=energyCostPerKg(state.newTemp,state.newTime,state.energyTariff,state.machineLoad);
  let oldTotal=oldChem+oldEnergy;
  let newTotal=newChem+newEnergy;
  let savePerKg=oldTotal-newTotal;
  let runs= runsPerDay(state.newTime,state.workHours);
  let vol = runs*state.machineLoad;
  let daily=savePerKg*vol, monthly=daily*22, yearly=daily*264;

  $('results').innerHTML=`
    <p>Стоимость 1 кг (текущие): ${money(oldTotal)} | (новые): ${money(newTotal)}</p>
    <p>Экономия на 1 кг: ${money(savePerKg)}</p>
    <p>Экономия в день: ${money(daily)}</p>
    <p>Экономия в месяц: ${money(monthly)}</p>
    <p><b>Экономия в год: ${money(yearly)}</b></p>
  `;

  if(chart) chart.destroy();
  chart = new Chart($('chartCompare'),{
    type:'bar',
    data:{labels:['Химия','Энергия (на 1 кг)'],
      datasets:[
        {label:'Текущая', data:[oldChem,oldEnergy], backgroundColor:'#2c7be5'},
        {label:'Новая', data:[newChem,newEnergy], backgroundColor:'#2fcb7c'}
      ]
    },
    options:{responsive:true, plugins:{legend:{position:'top'}}}
  });
}

setInterval(update,1000);

// ===================== PDF export =====================
function exportPdf(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});

  doc.setFont("helvetica","");
  doc.setFontSize(16);
  doc.setTextColor(44,123,229);
  doc.text("Отчёт по экономии",40,50);
  doc.setFontSize(10); doc.setTextColor(80,80,80);
  doc.text(new Date().toLocaleString(),40,68);

  doc.setFillColor(44,123,229);
  doc.rect(480,30,60,30,'F');

  // Считаем данные
  const oldChem = costPerKg(state.current);
  const newChem = costPerKg(state.new);
  const oldEnergy = energyCostPerKg(state.newTemp,state.newTime+15,state.energyTariff,state.machineLoad);
  const newEnergy = energyCostPerKg(state.newTemp,state.newTime,state.energyTariff,state.machineLoad);
  const oldTotal = oldChem+oldEnergy;
  const newTotal = newChem+newEnergy;
  const savePerKg = oldTotal-newTotal;
  const runs = runsPerDay(state.newTime,state.workHours);
  const vol = runs*state.machineLoad;
  const daily=savePerKg*vol, monthly=daily*22, yearly=daily*264;

  const rows = [
    ['Стоимость 1 кг (химия)', money(oldChem), money(newChem)],
    ['Стоимость 1 кг (энергия)', money(oldEnergy), money(newEnergy)],
    ['Общие затраты на 1 кг', money(oldTotal), money(newTotal)],
    ['Стирок в день', runs, runs],
    ['Объём в день (кг)', vol, vol],
    ['Экономия в день', '', money(daily)],
    ['Экономия в месяц', '', money(monthly)],
  ];

  doc.autoTable({
    head: [['Показатель','Текущий','Новый']],
    body: rows,
    startY:100,
    styles:{font:"helvetica",fontSize:10,cellPadding:4},
    headStyles:{fillColor:[44,123,229],textColor:255},
    theme:'grid'
  });

  // Вставляем график
  try{
    const canvas=$('chartCompare');
    const img=canvas.toDataURL('image/png',1.0);
    const y=doc.lastAutoTable.finalY+20;
    doc.addImage(img,'PNG',40,y,520,200);
    // Блок итоговой экономии
    doc.setFontSize(14);
    doc.setTextColor(47,203,124);
    doc.text("ИТОГО годовая экономия: "+money(yearly),40,y+240);
  }catch(e){ console.warn(e); }

  doc.save("savings_report.pdf");
}
</script>

</body>
</html>
