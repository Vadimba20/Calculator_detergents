<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ç–∫–æ–Ω–æ–º–∏–∏ –º–æ—é—â–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤</title>
  <meta name="description" content="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ç–∫–æ–Ω–æ–º–∏–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–≥–æ–¥—ã –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∂–∏–¥–∫–∏–µ –º–æ—é—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞. –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω, –æ–¥–∏–Ω —Ñ–∞–π–ª." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <style>
    :root{
      --blue:#2c7be5; --green:#2fcb7c; --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --card:#f8fafc; --border:#e2e8f0;
      --danger:#ef4444; --warn:#f59e0b;
    }
    .dark:root, .dark{
      --bg:#0b1220; --fg:#e5e7eb; --muted:#94a3b8; --card:#0f172a; --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0));backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 180deg,var(--blue),var(--green));display:grid;place-items:center;color:white;font-weight:800}
    .title{font-size:18px;font-weight:700}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--fg);padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.success{background:var(--green);border-color:var(--green);color:#003314}
    .btn.ghost{background:transparent}
    .btn.icon{padding:10px;border-radius:12px;display:grid;place-items:center;min-width:44px}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px}
    .card h2{margin:0 0 8px 0;font-size:16px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .field input, .field select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--fg)}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(44,123,229,0.12);color:var(--blue);border:1px solid rgba(44,123,229,0.25)}
    .warn{color:var(--warn);font-size:12px}
    .danger{color:var(--danger);font-size:12px}
    .section-title{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px;border-bottom:1px dashed var(--border);font-size:13px;text-align:left}
    tfoot td{font-weight:700}
    canvas{width:100%;height:320px}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .item{padding:14px;border-radius:14px;border:1px solid var(--border);background:var(--bg)}
    .item h3{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
    .item .val{font-size:20px;font-weight:800}
    footer{padding:40px 16px;color:var(--muted);text-align:center}
    @media (max-width: 980px){.grid.cols-3{grid-template-columns:1fr}.grid.cols-2{grid-template-columns:1fr}.kpi{grid-template-columns:repeat(2,1fr)}header .container{gap:12px}}
    @media (max-width: 520px){.kpi{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="container inline" style="justify-content:space-between">
      <div class="brand">
        <div class="logo" aria-label="logo">A</div>
        <div>
          <div class="title" data-i18n="appTitle">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ç–∫–æ–Ω–æ–º–∏–∏ –º–æ—é—â–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤</div>
          <div style="font-size:12px;color:var(--muted)" data-i18n="appSubtitle">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–≥–æ–¥—ã –¥–ª—è –ø—Ä–∞—á–µ—á–Ω—ã—Ö, —Ö–∏–º—á–∏—Å—Ç–æ–∫, –æ—Ç–µ–ª–µ–π</div>
        </div>
      </div>
      <div class="toolbar">
        <select id="lang" class="btn">
          <option value="ru">RU</option>
          <option value="en">EN</option>
        </select>
        <button id="themeToggle" class="btn icon" title="Theme">üåì</button>
        <button id="resetBtn" class="btn ghost">‚ü≤ <span data-i18n="reset">–°–±—Ä–æ—Å</span></button>
        <button id="calcBtn" class="btn primary">‚öô <span data-i18n="calculate">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</span></button>
        <button id="pdfBtn" class="btn success">‚¨á <span data-i18n="export">–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</span></button>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:20px">
    <!-- KPIs -->
    <section class="kpi" id="kpis">
      <div class="item"><h3 data-i18n="kpi_cost_old">–°—Ç–æ–∏–º–æ—Å—Ç—å 1 –∫–≥ (—Ç–µ–∫—É—â.)</h3><div class="val" id="kpiCostOld">‚Äî</div></div>
      <div class="item"><h3 data-i18n="kpi_cost_new">–°—Ç–æ–∏–º–æ—Å—Ç—å 1 –∫–≥ (–Ω–æ–≤–∞—è)</h3><div class="val" id="kpiCostNew">‚Äî</div></div>
      <div class="item"><h3 data-i18n="kpi_saving_kg">–≠–∫–æ–Ω–æ–º–∏—è / –∫–≥</h3><div class="val" id="kpiSavingKg">‚Äî</div></div>
      <div class="item"><h3 data-i18n="kpi_saving_year">–≠–∫–æ–Ω–æ–º–∏—è / –≥–æ–¥</h3><div class="val" id="kpiSavingYear">‚Äî</div></div>
    </section>

    <div class="grid cols-2" style="margin-top:16px">
      <!-- –û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
      <section class="card">
        <div class="section-title"><h2 data-i18n="section_general">–û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h2><span class="pill" id="validationBadge">OK</span></div>
        <div class="grid cols-3">
          <div class="field"><label data-i18n="load">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—à–∏–Ω—ã (–∫–≥)</label><input type="number" id="loadKg" min="1" step="0.1" value="10"></div>
          <div class="field"><label data-i18n="tariff">–¢–∞—Ä–∏—Ñ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ (‚ÇΩ/–∫–í—Ç¬∑—á)</label><input type="number" id="tariff" min="0" step="0.01" value="6"></div>
          <div class="field"><label data-i18n="workHours">–†–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å</label><input type="number" id="workHours" min="1" max="24" step="0.5" value="9"></div>
        </div>
        <div class="grid cols-3" style="margin-top:10px">
          <div class="field"><label data-i18n="currTemp">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (¬∞C)</label><input type="number" id="currTemp" min="0" max="100" step="1" value="60"></div>
          <div class="field"><label data-i18n="currTime">–í—Ä–µ–º—è —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (–º–∏–Ω)</label><input type="number" id="currTime" min="1" step="1" value="60"></div>
          <div class="field"><label><span data-i18n="reductions">–°–Ω–∏–∂–µ–Ω–∏—è (¬∞C / –º–∏–Ω)</span></label>
            <div class="inline">
              <input type="number" id="deltaTemp" placeholder="ŒîT" step="1" value="10" style="flex:1">
              <input type="number" id="deltaTime" placeholder="Œît" step="1" value="10" style="flex:1">
            </div>
            <div style="font-size:11px;color:var(--muted)" data-i18n="reductionHint">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏—à—å –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏; —Ä–∞—Å—á—ë—Ç ‚Äî –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã.</div>
          </div>
        </div>
      </section>

      <!-- –ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ -->
      <section class="card">
        <div class="section-title"><h2 data-i18n="section_new_program">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã</h2></div>
        <div class="grid cols-3">
          <div class="field"><label data-i18n="newTemp">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (¬∞C)</label><input type="number" id="newTemp" min="0" max="100" step="1" value="50"></div>
          <div class="field"><label data-i18n="newTime">–í—Ä–µ–º—è –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (–º–∏–Ω)</label><input type="number" id="newTime" min="1" step="1" value="50"></div>
          <div class="field"><label data-i18n="calcMode">–†–µ–∂–∏–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏</label>
            <select id="priceUnitMode">
              <option value="perL" data-i18n="pricePerL">–¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ –∑–∞ –ª–∏—Ç—Ä</option>
              <option value="perKg" data-i18n="pricePerKg">–¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ –∑–∞ –∫–∏–ª–æ–≥—Ä–∞–º–º</option>
            </select>
          </div>
        </div>
      </section>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <!-- –¢–µ–∫—É—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ -->
      <section class="card">
        <div class="section-title">
          <h2 data-i18n="section_current">–¢–µ–∫—É—â–∏–µ –º–æ—é—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞</h2>
          <div class="inline">
            <button class="btn icon" id="addCurrent">Ôºã</button>
            <span class="warn" id="warnCurrent"></span>
          </div>
        </div>
        <div class="grid" id="currentList"></div>
      </section>

      <!-- –ù–æ–≤—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ -->
      <section class="card">
        <div class="section-title">
          <h2 data-i18n="section_new">–ù–∞—à–∏ –Ω–æ–≤—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞</h2>
          <div class="inline">
            <button class="btn icon" id="addNew">Ôºã</button>
            <span class="warn" id="warnNew"></span>
          </div>
        </div>
        <div class="grid" id="newList"></div>
      </section>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <section class="card" style="margin-top:16px">
      <div class="section-title"><h2 data-i18n="section_results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2></div>
      <div class="grid cols-2">
        <div>
          <table id="resultsTable">
            <thead>
              <tr>
                <th data-i18n="t_metric">–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                <th data-i18n="t_current">–¢–µ–∫—É—â–∞—è</th>
                <th data-i18n="t_new">–ù–æ–≤–∞—è</th>
              </tr>
            </thead>
            <tbody>
              <tr><td data-i18n="chemPerKg">–•–∏–º–∏—è –Ω–∞ 1 –∫–≥ (‚ÇΩ)</td><td id="chemOld">‚Äî</td><td id="chemNew">‚Äî</td></tr>
              <tr><td data-i18n="energyPerKg">–≠–Ω–µ—Ä–≥–∏—è –Ω–∞ 1 –∫–≥ (‚ÇΩ)</td><td id="energyOld">‚Äî</td><td id="energyNew">‚Äî</td></tr>
              <tr><td data-i18n="totalPerKg">–ò—Ç–æ–≥–æ –Ω–∞ 1 –∫–≥ (‚ÇΩ)</td><td id="totalOld">‚Äî</td><td id="totalNew">‚Äî</td></tr>
              <tr><td data-i18n="washesPerDay">–°—Ç–∏—Ä–æ–∫ –≤ –¥–µ–Ω—å (—à—Ç)</td><td id="washesOld">‚Äî</td><td id="washesNew">‚Äî</td></tr>
              <tr><td data-i18n="kgPerDay">–û–±—ä—ë–º –≤ –¥–µ–Ω—å (–∫–≥)</td><td id="kgOld">‚Äî</td><td id="kgNew">‚Äî</td></tr>
              <tr><td data-i18n="savingPerDay">–≠–∫–æ–Ω–æ–º–∏—è –≤ –¥–µ–Ω—å (‚ÇΩ)</td><td colspan="2" id="saveDay">‚Äî</td></tr>
              <tr><td data-i18n="savingPerMonth">–≠–∫–æ–Ω–æ–º–∏—è –≤ –º–µ—Å—è—Ü (‚ÇΩ)</td><td colspan="2" id="saveMonth">‚Äî</td></tr>
              <tr><td data-i18n="savingPerYear">–≠–∫–æ–Ω–æ–º–∏—è –≤ –≥–æ–¥ (‚ÇΩ)</td><td colspan="2" id="saveYear">‚Äî</td></tr>
            </tbody>
          </table>
        </div>
        <div>
          <canvas id="compareChart" height="320"></canvas>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div>¬© <span id="year"></span> <span id="brandName">Atlas PRO</span> ‚Ä¢ <span data-i18n="footerNote">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</span></div>
  </footer>

  <!-- CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <script>
  // ====== i18n ======
  const I18N = {
    ru: {
      appTitle:"–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ç–∫–æ–Ω–æ–º–∏–∏ –º–æ—é—â–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤",
      appSubtitle:"–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–≥–æ–¥—ã –¥–ª—è –ø—Ä–∞—á–µ—á–Ω—ã—Ö, —Ö–∏–º—á–∏—Å—Ç–æ–∫, –æ—Ç–µ–ª–µ–π",
      reset:"–°–±—Ä–æ—Å", calculate:"–†–∞—Å—Å—á–∏—Ç–∞—Ç—å", export:"–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF",
      section_general:"–û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã", load:"–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—à–∏–Ω—ã (–∫–≥)", tariff:"–¢–∞—Ä–∏—Ñ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏ (‚ÇΩ/–∫–í—Ç¬∑—á)", workHours:"–†–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å",
      currTemp:"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (¬∞C)", currTime:"–í—Ä–µ–º—è —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (–º–∏–Ω)", reductions:"–°–Ω–∏–∂–µ–Ω–∏—è (¬∞C / –º–∏–Ω)", reductionHint:"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏—à—å –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏; —Ä–∞—Å—á—ë—Ç ‚Äî –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã.",
      section_new_program:"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã", newTemp:"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (¬∞C)", newTime:"–í—Ä–µ–º—è –Ω–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (–º–∏–Ω)",
      calcMode:"–†–µ–∂–∏–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏", pricePerL:"–¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ –∑–∞ –ª–∏—Ç—Ä", pricePerKg:"–¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ –∑–∞ –∫–∏–ª–æ–≥—Ä–∞–º–º",
      section_current:"–¢–µ–∫—É—â–∏–µ –º–æ—é—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞", section_new:"–ù–∞—à–∏ –Ω–æ–≤—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞",
      field_name:"–ù–∞–∑–≤–∞–Ω–∏–µ", field_price:"–¶–µ–Ω–∞ (‚ÇΩ)", field_price_unit:"–¶–µ–Ω–∞ –∑–∞", field_perL:"–ª", field_perKg:"–∫–≥", field_usage:"–†–∞—Å—Ö–æ–¥ (–º–ª/–∫–≥)", field_share:"–£—á–∞—Å—Ç–∏–µ (%)", field_density:"–í–µ—Å 1 –ª (–∫–≥)", remove:"–£–¥–∞–ª–∏—Ç—å",
      section_results:"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã", t_metric:"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å", t_current:"–¢–µ–∫—É—â–∞—è", t_new:"–ù–æ–≤–∞—è",
      chemPerKg:"–•–∏–º–∏—è –Ω–∞ 1 –∫–≥ (‚ÇΩ)", energyPerKg:"–≠–Ω–µ—Ä–≥–∏—è –Ω–∞ 1 –∫–≥ (‚ÇΩ)", totalPerKg:"–ò—Ç–æ–≥–æ –Ω–∞ 1 –∫–≥ (‚ÇΩ)", washesPerDay:"–°—Ç–∏—Ä–æ–∫ –≤ –¥–µ–Ω—å (—à—Ç)", kgPerDay:"–û–±—ä—ë–º –≤ –¥–µ–Ω—å (–∫–≥)", savingPerDay:"–≠–∫–æ–Ω–æ–º–∏—è –≤ –¥–µ–Ω—å (‚ÇΩ)", savingPerMonth:"–≠–∫–æ–Ω–æ–º–∏—è –≤ –º–µ—Å—è—Ü (‚ÇΩ)", savingPerYear:"–≠–∫–æ–Ω–æ–º–∏—è –≤ –≥–æ–¥ (‚ÇΩ)",
      kpi_cost_old:"–°—Ç–æ–∏–º–æ—Å—Ç—å 1 –∫–≥ (—Ç–µ–∫—É—â.)", kpi_cost_new:"–°—Ç–æ–∏–º–æ—Å—Ç—å 1 –∫–≥ (–Ω–æ–≤–∞—è)", kpi_saving_kg:"–≠–∫–æ–Ω–æ–º–∏—è / –∫–≥", kpi_saving_year:"–≠–∫–æ–Ω–æ–º–∏—è / –≥–æ–¥",
      footerNote:"–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.",
      warn_share:"–°—É–º–º–∞ —É—á–∞—Å—Ç–∏—è –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 100%",
      placeholder_name:"–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞"
    },
    en: {
      appTitle:"Detergent Savings Calculator",
      appSubtitle:"Demonstrate savings for laundries, dry cleaners, hotels",
      reset:"Reset", calculate:"Calculate", export:"Export PDF",
      section_general:"General parameters", load:"Machine load (kg)", tariff:"Electricity tariff (‚ÇΩ/kWh)", workHours:"Working hours per day",
      currTemp:"Current program temp (¬∞C)", currTime:"Current program time (min)", reductions:"Reductions (¬∞C / min)", reductionHint:"For reference only; calculations use the new program settings.",
      section_new_program:"New program settings", newTemp:"New program temp (¬∞C)", newTime:"New program time (min)",
      calcMode:"Price mode", pricePerL:"Price per liter", pricePerKg:"Price per kilogram",
      section_current:"Customer's current detergents", section_new:"Our new detergents",
      field_name:"Name", field_price:"Price (‚ÇΩ)", field_price_unit:"Price per", field_perL:"L", field_perKg:"kg", field_usage:"Dose (ml/kg)", field_share:"Share (%)", field_density:"Weight 1 L (kg)", remove:"Remove",
      section_results:"Results", t_metric:"Metric", t_current:"Current", t_new:"New",
      chemPerKg:"Chemistry per 1 kg (‚ÇΩ)", energyPerKg:"Energy per 1 kg (‚ÇΩ)", totalPerKg:"Total per 1 kg (‚ÇΩ)", washesPerDay:"Washes/day (pcs)", kgPerDay:"Throughput/day (kg)", savingPerDay:"Savings/day (‚ÇΩ)", savingPerMonth:"Savings/month (‚ÇΩ)", savingPerYear:"Savings/year (‚ÇΩ)",
      kpi_cost_old:"Cost per kg (current)", kpi_cost_new:"Cost per kg (new)", kpi_saving_kg:"Saving / kg", kpi_saving_year:"Saving / year",
      footerNote:"Works offline. Your data stays in the browser.",
      warn_share:"Sum of shares must not exceed 100%",
      placeholder_name:"Product name"
    }
  };

  // ====== State & helpers ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const money = n => isFinite(n) ? new Intl.NumberFormat(getLangLocale(), {style:'currency',currency:'RUB',maximumFractionDigits:2}).format(n) : '‚Äî';
  const num = (n, d=0) => isFinite(n) ? Number(n).toFixed(d) : '‚Äî';
  const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
  const getLang = () => localStorage.getItem('calc_lang') || 'ru';
  const getLangLocale = () => getLang()==='ru' ? 'ru-RU' : 'en-US';

  const LIMITS = {currentMax:5, newMax:8};

  const emptyItem = () => ({ name:'', price:0, usage:0, share:0, density:1.05 });

  const state = {
    loadKg: 10, tariff: 6, workHours: 9,
    currTemp: 60, currTime: 60, deltaTemp: 10, deltaTime: 10,
    newTemp: 50, newTime: 50, priceUnitMode: 'perL',
    current: [emptyItem()],
    next: [emptyItem()],
    brand: 'Atlas PRO'
  };

  const save = () => localStorage.setItem('detergent_calc_v1', JSON.stringify(state));
  const restore = () => {
    const raw = localStorage.getItem('detergent_calc_v1');
    if(!raw) return;
    try{ const s = JSON.parse(raw); Object.assign(state, s);}catch(e){}
  };

  // ====== UI rendering ======
  function renderI18n(){
    const lang = getLang();
    $$('#lang').forEach(el=> el.value = lang);
    $$('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const t = I18N[lang][key] || key;
      if(el.tagName==='INPUT' && el.placeholder){ el.placeholder = t; }
      else el.textContent = t;
    });
    // placeholders for dynamic rows updated in row renderer
  }

  function setTheme(initial){
    const stored = localStorage.getItem('calc_theme');
    const dark = initial ? stored === 'dark' : document.body.classList.toggle('dark');
    document.body.classList.toggle('dark', dark);
    if(!initial) localStorage.setItem('calc_theme', dark ? 'dark' : 'light');
  }

  function rowTemplate(kind, idx, data){
    const lang = getLang();
    return `
    <div class="grid cols-3" data-kind="${kind}" data-index="${idx}">
      <div class="field">
        <label>${I18N[lang].field_name}</label>
        <input type="text" data-field="name" placeholder="${I18N[lang].placeholder_name}" value="${data.name||''}">
      </div>
      <div class="field">
        <label>${I18N[lang].field_price}</label>
        <div class="inline">
          <input style="flex:1" type="number" min="0" step="0.01" data-field="price" value="${data.price||0}">
          <select data-field="priceUnit">
            <option value="perL" ${state.priceUnitMode==='perL'?'selected':''}>${I18N[lang].field_perL}</option>
            <option value="perKg" ${state.priceUnitMode==='perKg'?'selected':''}>${I18N[lang].field_perKg}</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>${I18N[lang].field_usage}</label>
        <input type="number" min="0" step="0.1" data-field="usage" value="${data.usage||0}">
      </div>
      <div class="field">
        <label>${I18N[lang].field_share}</label>
        <input type="number" min="0" max="100" step="0.1" data-field="share" value="${data.share||0}">
      </div>
      <div class="field">
        <label>${I18N[lang].field_density}</label>
        <input type="number" min="0.5" max="2" step="0.01" data-field="density" value="${data.density||1.05}">
      </div>
      <div class="field" style="justify-content:end">
        <button class="btn danger" data-action="remove">${I18N[lang].remove}</button>
      </div>
    </div>`;
  }

  function renderLists(){
    $('#currentList').innerHTML = state.current.map((item,i)=>rowTemplate('current', i, item)).join('');
    $('#newList').innerHTML = state.next.map((item,i)=>rowTemplate('next', i, item)).join('');
  }

  function bindDynamic(){
    ['currentList','newList'].forEach(listId=>{
      const container = document.getElementById(listId);
      container.oninput = (e)=>{
        const row = e.target.closest('[data-kind]'); if(!row) return;
        const kind = row.getAttribute('data-kind');
        const idx = +row.getAttribute('data-index');
        const field = e.target.getAttribute('data-field');
        const val = (e.target.type==='number') ? +e.target.value : e.target.value;
        const arr = kind==='current'?state.current:state.next;
        if(field){ arr[idx][field] = val; save(); calcAndRender(); }
      };
      container.onclick = (e)=>{
        const btn = e.target.closest('[data-action="remove"]');
        if(!btn) return;
        const row = btn.closest('[data-kind]');
        const kind = row.getAttribute('data-kind');
        const idx = +row.getAttribute('data-index');
        const arr = kind==='current'?state.current:state.next;
        arr.splice(idx,1); if(arr.length===0) arr.push(emptyItem());
        save(); renderLists(); bindDynamic(); calcAndRender();
      };
    });
  }

  function addRow(kind){
    if(kind==='current' && state.current.length>=LIMITS.currentMax){ shakeWarn('#warnCurrent'); return; }
    if(kind==='next' && state.next.length>=LIMITS.newMax){ shakeWarn('#warnNew'); return; }
    (kind==='current'?state.current:state.next).push(emptyItem());
    save(); renderLists(); bindDynamic();
  }

  function shakeWarn(sel){
    const el = $(sel); const lang = getLang();
    el.textContent = I18N[lang].warn_share; el.style.transition=''; el.style.opacity='1';
    setTimeout(()=>{ el.style.transition='opacity 1.2s'; el.style.opacity='0';}, 1400);
  }

  // ====== Calculations ======
  function calcChemPerKg(items){
    const mode = state.priceUnitMode; // global switch
    const sumShare = items.reduce((s,it)=>s + (parseFloat(it.share)||0),0);
    const over = sumShare>100+1e-6; // tolerance
    document.getElementById(items===state.current? 'warnCurrent':'warnNew').textContent = over ? I18N[getLang()].warn_share : '';
    // cost per kg linen
    // If price per L: cost = price * (usage_ml/1000) * (share%)
    // If price per Kg: cost = price * (usage_ml/1000) * density * (share%)
    const cost = items.reduce((acc,it)=>{
      const price = +it.price||0; const usageL = (+it.usage||0)/1000; const share = (+it.share||0)/100;
      const density = +it.density||1.05;
      const unitFactor = (mode==='perL') ? 1 : density;
      return acc + price * usageL * unitFactor * share;
    }, 0);
    return {cost, sumShare};
  }

  function energyKWh(temp, timeMin){
    const timeH = (timeMin||0)/60; return 0.05* (temp||0) + 0.1* timeH; // given approximation
  }

  function calcAll(){
    const loadKg = +state.loadKg||10; const tariff = +state.tariff||0; const workMin = (+state.workHours||9)*60;
    const currTemp = +state.currTemp||0; const currTime = +state.currTime||1;
    const newTemp = +state.newTemp||0; const newTime = +state.newTime||1;

    const chemOld = calcChemPerKg(state.current); // {cost,sumShare}
    const chemNew = calcChemPerKg(state.next);

    const eOld = energyKWh(currTemp, currTime);
    const eNew = energyKWh(newTemp, newTime);

    const energyCostOldPerKg = (eOld * tariff) / loadKg;
    const energyCostNewPerKg = (eNew * tariff) / loadKg;

    const totalOldPerKg = chemOld.cost + energyCostOldPerKg;
    const totalNewPerKg = chemNew.cost + energyCostNewPerKg;

    const washesOld = Math.floor(workMin / Math.max(currTime,1));
    const washesNew = Math.floor(workMin / Math.max(newTime,1));
    const kgOld = washesOld * loadKg;
    const kgNew = washesNew * loadKg;

    const dayCostOld = totalOldPerKg * kgOld;
    const dayCostNew = totalNewPerKg * kgNew;

    const saveDay = Math.max(0, dayCostOld - dayCostNew);
    const saveMonth = saveDay * 30;
    const saveYear = saveDay * 365;

    return { chemOld, chemNew, energyCostOldPerKg, energyCostNewPerKg, totalOldPerKg, totalNewPerKg, washesOld, washesNew, kgOld, kgNew, saveDay, saveMonth, saveYear };
  }

  // ====== Render results ======
  let chart;
  function calcAndRender(){
    // sync inputs -> state
    ['loadKg','tariff','workHours','currTemp','currTime','deltaTemp','deltaTime','newTemp','newTime'].forEach(id=>{
      const el = document.getElementById(id); if(!el) return; state[id] = +el.value; });
    state.priceUnitMode = document.getElementById('priceUnitMode').value;
    save();

    const R = calcAll();
    $('#chemOld').textContent = money(R.chemOld.cost);
    $('#chemNew').textContent = money(R.chemNew.cost);
    $('#energyOld').textContent = money(R.energyCostOldPerKg);
    $('#energyNew').textContent = money(R.energyCostNewPerKg);
    $('#totalOld').textContent = money(R.totalOldPerKg);
    $('#totalNew').textContent = money(R.totalNewPerKg);
    $('#washesOld').textContent = R.washesOld;
    $('#washesNew').textContent = R.washesNew;
    $('#kgOld').textContent = R.kgOld;
    $('#kgNew').textContent = R.kgNew;
    $('#saveDay').textContent = money(R.saveDay);
    $('#saveMonth').textContent = money(R.saveMonth);
    $('#saveYear').textContent = money(R.saveYear);

    $('#kpiCostOld').textContent = money(R.totalOldPerKg);
    $('#kpiCostNew').textContent = money(R.totalNewPerKg);
    $('#kpiSavingKg').textContent = money(Math.max(0, R.totalOldPerKg - R.totalNewPerKg));
    $('#kpiSavingYear').textContent = money(R.saveYear);

    // Validation badge
    const sumCurr = R.chemOld.sumShare; const sumNew = R.chemNew.sumShare;
    const ok = sumCurr<=100.001 && sumNew<=100.001;
    const badge = $('#validationBadge');
    badge.textContent = ok ? 'OK' : '>100%';
    badge.style.background = ok? 'rgba(47,203,124,0.15)' : 'rgba(239,68,68,0.15)';
    badge.style.color = ok? 'var(--green)' : 'var(--danger)';
    badge.style.borderColor = ok? 'rgba(47,203,124,0.4)' : 'rgba(239,68,68,0.4)';

    // Chart
    const ctx = document.getElementById('compareChart');
    const data = {
      labels: [I18N[getLang()].t_current, I18N[getLang()].t_new],
      datasets: [
        { label: I18N[getLang()].chemPerKg, data: [R.chemOld.cost, R.chemNew.cost], stack: 'cost' },
        { label: I18N[getLang()].energyPerKg, data: [R.energyCostOldPerKg, R.energyCostNewPerKg], stack: 'cost' }
      ]
    };
    const options = { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${money(ctx.parsed.y)}` } } } };

    if(chart){ chart.data = data; chart.options = options; chart.update(); }
    else { chart = new Chart(ctx, { type:'bar', data, options }); }
  }

  // ====== PDF export ======
  async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const lang = getLang();

    // Header with logo
    const logoCanvas = document.createElement('canvas');
    const g = logoCanvas.getContext('2d'); logoCanvas.width=120; logoCanvas.height=120; 
    const grad = g.createConicGradient(Math.PI,60,60); grad.addColorStop(0,'#2c7be5'); grad.addColorStop(1,'#2fcb7c');
    g.fillStyle=grad; g.beginPath(); g.arc(60,60,50,0,Math.PI*2); g.fill();
    g.fillStyle='#fff'; g.font='bold 56px Inter, Arial'; g.textAlign='center'; g.textBaseline='middle'; g.fillText('A',60,66);
    const logoData = logoCanvas.toDataURL('image/png');

    doc.addImage(logoData,'PNG',40,30,42,42);
    doc.setFontSize(16); doc.text(`${state.brand} ‚Äî ${I18N[lang].appTitle}`, 92, 50);
    doc.setFontSize(10); doc.setTextColor(120); doc.text(new Date().toLocaleString(getLangLocale()), 92, 66);
    doc.setTextColor(0);

    // Summary KPIs
    const R = calcAll();
    const kpi = [
      [I18N[lang].kpi_cost_old, money(R.totalOldPerKg)],
      [I18N[lang].kpi_cost_new, money(R.totalNewPerKg)],
      [I18N[lang].kpi_saving_kg, money(Math.max(0,R.totalOldPerKg-R.totalNewPerKg))],
      [I18N[lang].kpi_saving_year, money(R.saveYear)]
    ];
    doc.autoTable({startY:90, head:[[I18N[lang].t_metric,'']], body:kpi, styles:{ fontSize:10 }});

    // Inputs table
    const inputs = [
      [I18N[lang].load, state.loadKg], [I18N[lang].tariff, state.tariff], [I18N[lang].workHours, state.workHours],
      [I18N[lang].currTemp, state.currTemp], [I18N[lang].currTime, state.currTime], [I18N[lang].newTemp, state.newTemp], [I18N[lang].newTime, state.newTime],
      [I18N[lang].calcMode, I18N[lang][ state.priceUnitMode==='perL'? 'pricePerL':'pricePerKg' ]]
    ];
    doc.autoTable({ startY: doc.lastAutoTable.finalY + 14, head:[[I18N[lang].section_general,'']], body:inputs, styles:{ fontSize:9 } });

    // Detergents tables
    const toRows = arr => arr.map(it=>[it.name||'', it.price, it.usage, it.share, it.density]);
    doc.autoTable({ startY: doc.lastAutoTable.finalY + 14, head:[[I18N[lang].section_current,'–¶–µ–Ω–∞', '–†–∞—Å—Ö–æ–¥ (–º–ª/–∫–≥)','–£—á–∞—Å—Ç–∏–µ (%)','–í–µ—Å 1 –ª (–∫–≥)']], body: toRows(state.current), styles:{ fontSize:8 } });
    doc.autoTable({ startY: doc.lastAutoTable.finalY + 8, head:[[I18N[lang].section_new,'–¶–µ–Ω–∞', '–†–∞—Å—Ö–æ–¥ (–º–ª/–∫–≥)','–£—á–∞—Å—Ç–∏–µ (%)','–í–µ—Å 1 –ª (–∫–≥)']], body: toRows(state.next), styles:{ fontSize:8 } });

    // Chart image
    const chartCanvas = document.getElementById('compareChart');
    const chartImg = chartCanvas.toDataURL('image/png', 1.0);
    const w = 460; const h = w * chartCanvas.height / chartCanvas.width;
    doc.addPage();
    doc.setFontSize(12); doc.text(I18N[lang].section_results, 40, 40);
    doc.addImage(chartImg, 'PNG', 40, 60, w, h);

    // Results table
    const resRows = [
      [I18N[lang].chemPerKg, money(R.chemOld.cost), money(R.chemNew.cost)],
      [I18N[lang].energyPerKg, money(R.energyCostOldPerKg), money(R.energyCostNewPerKg)],
      [I18N[lang].totalPerKg, money(R.totalOldPerKg), money(R.totalNewPerKg)],
      [I18N[lang].washesPerDay, R.washesOld, R.washesNew],
      [I18N[lang].kgPerDay, R.kgOld, R.kgNew],
      [I18N[lang].savingPerDay, money(R.saveDay), ''],
      [I18N[lang].savingPerMonth, money(R.saveMonth), ''],
      [I18N[lang].savingPerYear, money(R.saveYear), '']
    ];
    doc.autoTable({ startY: 60+h+16, head:[[I18N[lang].t_metric, I18N[lang].t_current, I18N[lang].t_new]], body:resRows, styles:{ fontSize:9 } });

    doc.save('detergent-savings.pdf');
  }

  // ====== Init ======
  function init(){
    restore();

    // set inputs
    $('#loadKg').value = state.loadKg; $('#tariff').value = state.tariff; $('#workHours').value = state.workHours;
    $('#currTemp').value = state.currTemp; $('#currTime').value = state.currTime; $('#deltaTemp').value = state.deltaTemp; $('#deltaTime').value = state.deltaTime;
    $('#newTemp').value = state.newTemp; $('#newTime').value = state.newTime; $('#priceUnitMode').value = state.priceUnitMode;

    renderLists(); bindDynamic();

    // Events
    $('#addCurrent').onclick = ()=> addRow('current');
    $('#addNew').onclick = ()=> addRow('next');
    $('#calcBtn').onclick = calcAndRender;
    $('#pdfBtn').onclick = exportPDF;
    $('#resetBtn').onclick = ()=>{ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')){ localStorage.removeItem('detergent_calc_v1'); location.reload(); } };

    // autosave for header inputs
    $$('input, select').forEach(el=>{
      el.addEventListener('change', ()=>{ calcAndRender(); });
      el.addEventListener('input', ()=>{ calcAndRender(); });
    });

    // Language & theme
    $('#lang').value = getLang();
    $('#lang').onchange = (e)=>{ localStorage.setItem('calc_lang', e.target.value); renderI18n(); renderLists(); calcAndRender(); };
    setTheme(true); $('#themeToggle').onclick = ()=> setTheme(false);

    // footer year
    $('#year').textContent = new Date().getFullYear();

    renderI18n();
    calcAndRender();
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
