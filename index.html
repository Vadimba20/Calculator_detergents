<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Калькулятор экономии моющих средств</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232c7be5%22/></svg>">
  <meta name="description" content="Онлайн-калькулятор экономии моющих средств — расчёт стоимости 1 кг, экономии энергии, производительности и годовой экономии. Работает локально и на GitHub Pages." />

  <!-- CDN libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --blue: #007BCC; /* Основной цвет бренда */
      --orange: #FF9900; /* Акцентный цвет */
      --muted: #6b7280;
      --bg: linear-gradient(180deg, #e6f3ff, #ffffff);
      --card: #ffffff;
      --text: #0b1220;
      --border: #e6eef8;
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      font-family: 'Inter', 'Roboto', sans-serif;
      color: var(--text);
    }

    .wrap {
      max-width: 1100px;
      margin: 18px auto;
      padding: 12px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      width: 100px;
      height: 100px;
      border-radius: 10px;
      background: url('https://static.tildacdn.com/tild6432-6161-4033-a336-663833306334/_.png') no-repeat center center; 
      background-size: contain;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 20px;
    }

    h1 {
      font-size: 18px;
      margin: 0;
      color: var(--text);
      font-weight: 600;
    }

    p.lead {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .top-controls {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    select, input[type=search] {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
    }

    button {
      cursor: pointer;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--blue);
      color: white;
    }

    .btn-secondary {
      background: var(--orange);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--blue);
      color: var(--blue);
    }

    main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 20px;
    }

    @media (min-width: 980px) {
      main { grid-template-columns: 360px 1fr; }
    }

    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(15, 30, 60, 0.06);
      border: 1px solid var(--border);
    }

    .section-title {
      font-weight: 600;
      color: var(--blue);
      margin-bottom: 12px;
      font-size: 16px;
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input[type=number], input[type=text] {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
    }

    .table-wrap {
      overflow-x: auto;
      margin-top: 8px;
    }

    table.dt {
      width: 100%;
      border-collapse: collapse;
    }

    table.dt thead th {
      background: #f0f7ff;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-weight: 500;
    }

    table.dt td {
      padding: 8px;
      border-bottom: 1px solid #f4f9ff;
    }

    table.dt input {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .remove {
      color: #e53935;
      font-weight: 700;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    @media (max-width: 640px) {
      .results-grid { grid-template-columns: 1fr; }
    }

    .stat {
      padding: 12px;
      border-radius: 10px;
      background: #f8fbff;
      border: 1px solid #e6f0ff;
    }

    .stat h4 {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .stat p {
      margin: 6px 0 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    footer {
      margin-top: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }

    /* Responsive: Table to stacked */
    @media (max-width: 640px) {
      table.dt, table.dt thead, table.dt tbody, table.dt th, table.dt td, table.dt tr {
        display: block;
      }
      table.dt thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      table.dt tr {
        margin: 0 0 12px;
      }
      table.dt td {
        border: none;
        position: relative;
        padding-left: 50%;
      }
      table.dt td:before {
        position: absolute;
        left: 12px;
        top: 10px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: 600;
      }
      table.dt td[data-label="Название"]:before { content: "Название"; }
      table.dt td[data-label="Цена"]:before { content: "Цена за упаковку (₽)"; }
      table.dt td[data-label="Вес"]:before { content: "Вес упаковки (кг)"; }
      table.dt td[data-label="Дозировка"]:before { content: "Дозировка (мл/г)"; }
      table.dt td[data-label="Действие"]:before { content: ""; }
    }

    /* Validation styles */
    .validation-error {
      border: 1px solid #e53935 !important;
    }

    .tooltip {
      position: relative;
      display: inline-block;
      border-bottom: 1px dotted #ccc;
      cursor: help;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    .info-text {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <div>
        <h1 id="appTitle">Калькулятор экономии моющих средств</h1>
        <p class="lead">Покажите клиенту экономию на химии и энергии при переходе на современные средства</p>
      </div>

      <div class="top-controls">
        <select id="langSelect" title="Language">
          <option value="ru">RU</option>
          <option value="en">EN</option>
        </select>
        <button id="exportBtn" class="btn btn-secondary">Экспорт в PDF</button>
      </div>
    </header>

    <main>
      <!-- Left column: inputs -->
      <section class="card">
        <div class="section-title">Общие параметры</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label id="labelLoad">Загрузка машины (кг)</label>
            <input id="machineLoad" type="number" min="1" value="10" />
          </div>
          <div>
            <label id="labelTariff">Тариф электроэнергии (₽/кВт·ч)</label>
            <input id="energyTariff" type="number" min="0" step="0.01" value="6.5" />
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
          <div>
            <label id="labelWork">Рабочих часов в день</label>
            <input id="workHours" type="number" min="1" value="9" />
          </div>
          <div>
            <label>Тариф воды (₽/м³) <span class="tooltip">ℹ<span class="tooltiptext">Стоимость одного кубометра воды</span></span></label>
            <input id="waterTariff" type="number" min="0" step="0.01" value="45" />
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)" />

        <div class="section-title">Текущие моющие средства</div>
        <div class="table-wrap">
          <table id="currentTable" class="dt">
            <thead>
              <tr>
                <th>Название</th>
                <th>Цена за упаковку (₽)</th>
                <th>Вес упаковки (кг)</th>
                <th>Дозировка (мл/г) на 1 кг</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="addCurrent">+ Добавить средство</button>
          <button class="btn btn-outline" id="clearCurrent">Сбросить</button>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)" />

        <div class="section-title">Наши новые средства</div>
        <div class="table-wrap">
          <table id="newTable" class="dt">
            <thead>
              <tr>
                <th>Название</th>
                <th>Цена за упаковку (₽)</th>
                <th>Вес упаковки (кг)</th>
                <th>Дозировка (мл/г) на 1 кг</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="addNew">+ Добавить средство</button>
          <button class="btn btn-outline" id="clearNew">Сбросить</button>
        </div>
      </section>

      <!-- Right column: program params + results -->
      <section>
        <div class="card">
          <div class="section-title">Параметры программ</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
            <div>
              <label id="labelOldTemp">Температура текущей программы (°C)</label>
              <input id="oldTemp" type="number" min="0" value="60" />
            </div>
            <div>
              <label id="labelOldTime">Время текущей программы (мин)</label>
              <input id="oldTime" type="number" min="1" value="60" />
            </div>
            <div>
              <label id="labelNewTemp">Температура новой программы (°C)</label>
              <input id="newTemp" type="number" min="0" value="40" />
            </div>
            <div>
              <label id="labelNewTime">Время новой программы (мин)</label>
              <input id="newTime" type="number" min="1" value="45" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Мощность стиральной машины (кВт) <span class="tooltip">ℹ<span class="tooltiptext">Указана в технических характеристиках машины</span></span></label>
            <input id="machinePower" type="number" min="0.1" step="0.1" value="2.5" />
          </div>

          <div style="margin-top:10px">
            <label>Расход воды (л/кг белья) <span class="tooltip">ℹ<span class="tooltiptext">Примерный расход воды на килограмм белья</span></span></label>
            <input id="waterConsumption" type="number" min="1" step="0.5" value="10" />
            <div class="info-text">Обычно от 8 до 15 литров на кг в современных машинах</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <button class="btn btn-primary" id="calcBtn">Рассчитать</button>
            <button class="btn btn-outline" id="resetBtn">Сбросить всё</button>
            <div style="margin-left:auto;color:var(--muted);font-size:13px">Автосохранение: включено</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="section-title">Результаты</div>

          <div class="results-grid">
            <div class="stat"><h4>Стоимость 1 кг (химия)</h4><p id="costOldChem">— ₽</p></div>
            <div class="stat"><h4>Стоимость 1 кг (химия) — новая</h4><p id="costNewChem">— ₽</p></div>
            <div class="stat"><h4>Стоимость энергии на 1 кг — старое</h4><p id="costOldEnergy">— ₽</p></div>
            <div class="stat"><h4>Стоимость энергии на 1 кг — новое</h4><p id="costNewEnergy">— ₽</p></div>
            <div class="stat"><h4>Стоимость воды на 1 кг — старое</h4><p id="costOldWater">— ₽</p></div>
            <div class="stat"><h4>Стоимость воды на 1 кг — новое</h4><p id="costNewWater">— ₽</p></div>
            <div class="stat"><h4>Экономия на 1 кг</h4><p id="savingPerKg">— ₽</p></div>
            <div class="stat"><h4>Экономия в день (новая пропускная способность)</h4><p id="savingDay">— ₽</p></div>
          </div>

          <div style="margin-top:12px"><canvas id="chartCompare" height="160"></canvas></div>

          <div style="margin-top:12px;overflow:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead><tr><th style="text-align:left;padding:8px">Показатель</th><th style="padding:8px">Текущий</th><th style="padding:8px">Новый</th></tr></thead>
              <tbody>
                <tr><td style="padding:8px">Стоимость 1 кг (химия)</td><td id="t_old_chem" style="padding:8px">—</td><td id="t_new_chem" style="padding:8px">—</td></tr>
                <tr><td style="padding:8px">Стоимость 1 кг (энергия)</td><td id="t_old_energy" style="padding:8px">—</td><td id="t_new_energy" style="padding:8px">—</td></tr>
                <tr><td style="padding:8px">Стоимость 1 кг (вода)</td><td id="t_old_water" style="padding:8px">—</td><td id="t_new_water" style="padding:8px">—</td></tr>
                <tr><td style="padding:8px">Время программы (мин)</td><td id="t_old_time" style="padding:8px">—</td><td id="t_new_time" style="padding:8px">—</td></tr>
                <tr><td style="padding:8px">Стирок в день</td><td id="t_old_runs" style="padding:8px">—</td><td id="t_new_runs" style="padding:8px">—</td></tr>
                <tr><td style="padding:8px">Объём в день (кг)</td><td id="t_old_vol" style="padding:8px">—</td><td id="t_new_vol" style="padding:8px">—</td></tr>
                <tr><td style="padding:8px">Экономия в месяц (≈22 раб. дня)</td><td colspan="2" id="t_month_save" style="padding:8px">—</td></tr>
                <tr><td style="padding:8px">Экономия в год (≈264 раб. дня)</td><td colspan="2" id="t_year_save" style="padding:8px">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div>Один файл: <strong>index.html</strong> — работает локально и на GitHub Pages / Netlify.</div>
    </footer>
  </div>

  <script>
    // ===================== i18n strings =====================
    const I18N = {
      ru: {
        appTitle: 'Калькулятор экономии моющих средств',
        add: '+ Добавить средство', reset: 'Сбросить', calc: 'Рассчитать', export: 'Экспорт в PDF', resetAll: 'Сбросить всё', autosaveOn: 'Автосохранение: включено',
        reportTitle: 'Отчёт по экономии',
        parameter: 'Показатель', current: 'Текущий', new: 'Новый',
        chemCost: 'Стоимость 1 кг (химия)', energyCost: 'Стоимость 1 кг (энергия)', waterCost: 'Стоимость 1 кг (вода)',
        chemistry: 'Химия', energy: 'Энергия', water: 'Вода',
        programTime: 'Время программы (мин)', runsPerDay: 'Стирок в день', volumePerDay: 'Объём в день (кг)',
        monthSaving: 'Экономия в месяц (≈22 раб. дня)', yearSaving: 'Экономия в год (≈264 раб. дня)'
      }, 
      en: {
        appTitle: 'Detergent Savings Calculator', 
        add: '+ Add detergent', reset: 'Reset', calc: 'Calculate', export: 'Export to PDF', resetAll: 'Reset all', autosaveOn: 'Autosave: on',
        reportTitle: 'Savings report',
        parameter: 'Parameter', current: 'Current', new: 'New',
        chemCost: 'Cost per kg (chemistry)', energyCost: 'Cost per kg (energy)', waterCost: 'Cost per kg (water)',
        chemistry: 'Chemistry', energy: 'Energy', water: 'Water',
        programTime: 'Program time (min)', runsPerDay: 'Runs per day', volumePerDay: 'Volume per day (kg)',
        monthSaving: 'Monthly saving (≈22 work days)', yearSaving: 'Yearly saving (≈264 work days)'
      }
    }

    // ===================== helpers =====================
    const $ = id => document.getElementById(id);
    const money = v => (typeof v === 'number' ? v.toFixed(2) + ' ₽' : '—');

    // default state
    let state = {
      machineLoad: 10,
      energyTariff: 6.5,
      workHours: 9,
      waterTariff: 45,
      current: [],
      new: [],
      oldTemp: 60,
      newTemp: 40,
      newTime: 45,
      oldTime: 60,
      machinePower: 2.5,
      waterConsumption: 10,
      lang: 'ru'
    }

    // load from localStorage
    function loadState(){
      try{const s = JSON.parse(localStorage.getItem('detergent_calc_v1')); if(s) state = Object.assign(state,s);}catch(e){console.warn(e)}
    }
    function saveState(){ localStorage.setItem('detergent_calc_v1', JSON.stringify(state)); }

    loadState();

    // ===================== Validation =====================
    function validateInput(input, min, max) {
      const value = parseFloat(input.value);
      if (isNaN(value) || value < min || (max !== undefined && value > max)) {
        input.classList.add('validation-error');
        return false;
      } else {
        input.classList.remove('validation-error');
        return true;
      }
    }

    // ===================== UI: table rows =====================
    function makeRow(item, tableType, idx){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Название"><input type="text" value="${escapeHtml(item.name||'')}" placeholder="Название" data-field="name"/></td>
        <td data-label="Цена"><input type="number" min="0" step="0.01" value="${item.price||0}" data-field="price"/></td>
        <td data-label="Вес"><input type="number" min="0.001" step="0.001" value="${item.weight||1}" data-field="weight"/></td>
        <td data-label="Дозировка"><input type="number" min="0" step="0.01" value="${item.dose||0}" data-field="dose"/></td>
        <td data-label="Действие"><button class="remove" title="Удалить">✖</button></td>
      `;
      // bindings
      tr.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const field = inp.getAttribute('data-field');
          const val = inp.type === 'number' ? parseFloat(inp.value||0) : inp.value;

          // Validate input
          if (inp.type === 'number') {
            const min = field === 'weight' ? 0.001 : 0;
            validateInput(inp, min);
          }

          state[tableType][idx][field] = val;
          saveState(); compute();
        });
      });
      tr.querySelector('.remove').addEventListener('click', ()=>{
        state[tableType].splice(idx,1); renderTables(); saveState(); compute();
      });
      return tr;
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'<').replace(/>/g,'>').replace(/"/g,'&quot;'); }

    function renderTables(){
      const curBody = $('currentTable').querySelector('tbody'); curBody.innerHTML='';
      state.current.forEach((it,idx)=> curBody.appendChild(makeRow(it,'current',idx)));
      const newBody = $('newTable').querySelector('tbody'); newBody.innerHTML='';
      state.new.forEach((it,idx)=> newBody.appendChild(makeRow(it,'new',idx)));
    }

    // add row utilities
    function addDetergent(type){ state[type].push({name:'',price:0,weight:1,dose:0}); renderTables(); saveState(); }
    function clearTable(type){ if(confirm('Очистить список?')){ state[type]=[]; renderTables(); saveState(); compute(); } }

    // initial: ensure at least one row each (but only if state empty)
    if(!state.current.length) state.current.push({name:'Пример',price:0,weight:1,dose:0});
    if(!state.new.length) state.new.push({name:'Новое',price:0,weight:1,dose:0});

    // bind buttons
    $('addCurrent').addEventListener('click', ()=>addDetergent('current'));
    $('addNew').addEventListener('click', ()=>addDetergent('new'));
    $('clearCurrent').addEventListener('click', ()=>clearTable('current'));
    $('clearNew').addEventListener('click', ()=>clearTable('new'));
    $('resetBtn').addEventListener('click', ()=>{ if(confirm('Сбросить все данные?')){ localStorage.removeItem('detergent_calc_v1'); location.reload(); } });

    // general inputs binding with validation
    function bindInputWithValidation(inputId, stateProperty, min, max) {
      const input = $(inputId);
      input.addEventListener('input', ()=>{
        if (validateInput(input, min, max)) {
          state[stateProperty] = parseFloat(input.value);
          saveState(); 
          compute();
        }
      });
    }

    bindInputWithValidation('machineLoad', 'machineLoad', 1);
    bindInputWithValidation('energyTariff', 'energyTariff', 0);
    bindInputWithValidation('workHours', 'workHours', 1, 24);
    bindInputWithValidation('waterTariff', 'waterTariff', 0);
    bindInputWithValidation('oldTemp', 'oldTemp', 0, 100);
    bindInputWithValidation('newTemp', 'newTemp', 0, 100);
    bindInputWithValidation('newTime', 'newTime', 1);
    bindInputWithValidation('oldTime', 'oldTime', 1);
    bindInputWithValidation('machinePower', 'machinePower', 0.1, 10);
    bindInputWithValidation('waterConsumption', 'waterConsumption', 1, 20);

    // set UI from state
    function initUI(){
      $('machineLoad').value = state.machineLoad;
      $('energyTariff').value = state.energyTariff;
      $('workHours').value = state.workHours;
      $('waterTariff').value = state.waterTariff;
      $('oldTemp').value = state.oldTemp;
      $('newTemp').value = state.newTemp;
      $('newTime').value = state.newTime;
      $('oldTime').value = state.oldTime;
      $('machinePower').value = state.machinePower;
      $('waterConsumption').value = state.waterConsumption;
      $('langSelect').value = state.lang || 'ru';
      applyLang(state.lang || 'ru');
    }

    // ===================== Improved Calculations =====================
    function costPerKg(list){ 
      if(!Array.isArray(list) || !list.length) return 0; 
      let sum=0; 
      list.forEach(it=>{ 
        const price=Number(it.price)||0; 
        const weight=Number(it.weight)||1; 
        const dose=Number(it.dose)||0; 
        const fraction = dose / (weight*1000); 
        sum += price * fraction; 
      }); 
      return sum; 
    }

    function energyKWh(temp, timeMin, power){
      const heatingPower = power * 0.8;
      const motorPower = power * 0.2;
      const heatingTime = Math.min(timeMin * 0.5, 30);
      const motorTime = timeMin;
      const heatingEnergy = (heatingPower * heatingTime / 60) * (temp / 80);
      const motorEnergy = motorPower * motorTime / 60;
      return heatingEnergy + motorEnergy;
    }

    function energyCostPerKg(temp, timeMin, tariff, machineLoad, power){
      const e = energyKWh(temp, timeMin, power);
      return (e * (tariff||0)) / (machineLoad||1);
    }

    function waterCostPerKg(waterConsumption, tariff, machineLoad) {
      const waterPerLoad = waterConsumption * machineLoad;
      const waterCostPerLoad = (waterPerLoad * tariff) / 1000;
      return waterCostPerLoad / machineLoad;
    }

    function runsPerDay(timeMin, workHours){ 
      const minutesAvailable = (workHours||9) * 60; 
      return Math.floor(minutesAvailable / (timeMin||1)); 
    }

    // compute and render results
    let chart;
    function compute(){
      const inputsValid = [
        validateInput($('machineLoad'), 1),
        validateInput($('energyTariff'), 0),
        validateInput($('workHours'), 1, 24),
        validateInput($('waterTariff'), 0),
        validateInput($('oldTemp'), 0, 100),
        validateInput($('newTemp'), 0, 100),
        validateInput($('newTime'), 1),
        validateInput($('oldTime'), 1),
        validateInput($('machinePower'), 0.1, 10),
        validateInput($('waterConsumption'), 1, 20)
      ].every(valid => valid);

      if (!inputsValid) {
        alert('Пожалуйста, проверьте введенные данные. Некоторые значения некорректны.');
        return;
      }

      const oldChem = costPerKg(state.current);
      const newChem = costPerKg(state.new);
      const oldEnergyCost = energyCostPerKg(state.oldTemp, state.oldTime, state.energyTariff, state.machineLoad, state.machinePower);
      const newEnergyCost = energyCostPerKg(state.newTemp, state.newTime, state.energyTariff, state.machineLoad, state.machinePower);
      const oldWaterCost = waterCostPerKg(state.waterConsumption, state.waterTariff, state.machineLoad);
      const newWaterCost = waterCostPerKg(state.waterConsumption, state.waterTariff, state.machineLoad);

      const oldTotal = oldChem + oldEnergyCost + oldWaterCost;
      const newTotal = newChem + newEnergyCost + newWaterCost;
      const savePerKg = oldTotal - newTotal;

      const oldRuns = runsPerDay(state.oldTime, state.workHours);
      const newRuns = runsPerDay(state.newTime, state.workHours);
      const oldVol = oldRuns * state.machineLoad;
      const newVol = newRuns * state.machineLoad;

      const dailySaving = savePerKg * newVol;
      const monthlySaving = dailySaving * 22;
      const yearlySaving = dailySaving * 264;

      $('costOldChem').innerText = money(oldChem);
      $('costNewChem').innerText = money(newChem);
      $('costOldEnergy').innerText = money(oldEnergyCost);
      $('costNewEnergy').innerText = money(newEnergyCost);
      $('costOldWater').innerText = money(oldWaterCost);
      $('costNewWater').innerText = money(newWaterCost);
      $('savingPerKg').innerText = money(savePerKg);
      $('savingDay').innerText = money(dailySaving);

      $('t_old_chem').innerText = money(oldChem);
      $('t_new_chem').innerText = money(newChem);
      $('t_old_energy').innerText = money(oldEnergyCost);
      $('t_new_energy').innerText = money(newEnergyCost);
      $('t_old_water').innerText = money(oldWaterCost);
      $('t_new_water').innerText = money(newWaterCost);
      $('t_old_time').innerText = state.oldTime + ' мин';
      $('t_new_time').innerText = state.newTime + ' мин';
      $('t_old_runs').innerText = oldRuns + ' ц.';
      $('t_new_runs').innerText = newRuns + ' ц.';
      $('t_old_vol').innerText = oldVol + ' кг';
      $('t_new_vol').innerText = newVol + ' кг';
      $('t_month_save').innerText = money(monthlySaving);
      $('t_year_save').innerText = money(yearlySaving);

      const ctx = $('chartCompare').getContext('2d');
      const dataOld = [oldChem, oldEnergyCost, oldWaterCost];
      const dataNew = [newChem, newEnergyCost, newWaterCost];
      if(!chart){
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels:[I18N[state.lang].chemistry, I18N[state.lang].energy, I18N[state.lang].water],
            datasets:[
              {label: I18N[state.lang].current, data:dataOld, backgroundColor: 'rgba(0,123,204,0.8)'},
              {label: I18N[state.lang].new, data:dataNew, backgroundColor: 'rgba(255,153,0,0.8)'}
            ]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{y:{beginAtZero:true}},
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ₽';
                  }
                }
              }
            }
          }
        });
      } else {
        chart.data.datasets[0].data = dataOld; 
        chart.data.datasets[1].data = dataNew; 
        chart.update();
      }

      saveState();
    }

    // ===================== PDF export =====================
    async function exportPdf(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(20);
      doc.text(I18N[state.lang].reportTitle, 105, 20, { align: 'center' });
      doc.setFontSize(12);
      doc.text(new Date().toLocaleString(), 105, 30, { align: 'center' });

      // Logo
      doc.setFillColor(0, 123, 204);
      doc.rect(180, 10, 15, 15, 'F');
      doc.setFontSize(14);
      doc.setTextColor(255, 255, 255);
      doc.text('A', 187.5, 20, { align: 'center' });
      doc.setTextColor(0, 0, 0);

      const oldChem = costPerKg(state.current);
      const newChem = costPerKg(state.new);
      const oldEnergyCost = energyCostPerKg(state.oldTemp, state.oldTime, state.energyTariff, state.machineLoad, state.machinePower);
      const newEnergyCost = energyCostPerKg(state.newTemp, state.newTime, state.energyTariff, state.machineLoad, state.machinePower);
      const oldWaterCost = waterCostPerKg(state.waterConsumption, state.waterTariff, state.machineLoad);
      const newWaterCost = waterCostPerKg(state.waterConsumption, state.waterTariff, state.machineLoad);

      doc.setFontSize(14);
      doc.text('Сравнение стоимости на 1 кг белья:', 20, 50);

      doc.setFontSize(12);
      doc.text('Показатель', 20, 60);
      doc.text('Текущий', 100, 60);
      doc.text('Новый', 160, 60);
      doc.line(20, 65, 190, 65);

      let yPos = 75;
      doc.text(I18N[state.lang].chemCost, 20, yPos);
      doc.text(money(oldChem), 100, yPos);
      doc.text(money(newChem), 160, yPos);
      yPos += 10;

      doc.text(I18N[state.lang].energyCost, 20, yPos);
      doc.text(money(oldEnergyCost), 100, yPos);
      doc.text(money(newEnergyCost), 160, yPos);
      yPos += 10;

      doc.text(I18N[state.lang].waterCost, 20, yPos);
      doc.text(money(oldWaterCost), 100, yPos);
      doc.text(money(newWaterCost), 160, yPos);
      yPos += 15;

      const oldRuns = runsPerDay(state.oldTime, state.workHours);
      const newRuns = runsPerDay(state.newTime, state.workHours);
      const oldVol = oldRuns * state.machineLoad;
      const newVol = newRuns * state.machineLoad;
      const oldTotal = oldChem + oldEnergyCost + oldWaterCost;
      const newTotal = newChem + newEnergyCost + newWaterCost;
      const savePerKg = oldTotal - newTotal;
      const dailySaving = savePerKg * newVol;
      const monthlySaving = dailySaving * 22;
      const yearlySaving = dailySaving * 264;

      doc.setFontSize(14);
      doc.text('Экономические показатели:', 20, yPos);
      yPos += 10;

      doc.setFontSize(12);
      doc.text(`Экономия на 1 кг: ${money(savePerKg)}`, 20, yPos);
      yPos += 10;
      doc.text(`Экономия в день: ${money(dailySaving)}`, 20, yPos);
      yPos += 10;
      doc.text(`Экономия в месяц (22 дня): ${money(monthlySaving)}`, 20, yPos);
      yPos += 10;
      doc.text(`Экономия в год (264 дня): ${money(yearlySaving)}`, 20, yPos);
      yPos += 20;

      try {
        const canvas = $('chartCompare');
        const imgData = canvas.toDataURL('image/png');
        doc.setFontSize(14);
        doc.text('Сравнение стоимости:', 105, yPos, { align: 'center' });
        yPos += 10;
        doc.addImage(imgData, 'PNG', 40, yPos, 130, 80);
      } catch(e) {
        console.warn('Chart capture failed', e);
      }

      doc.save('savings_report.pdf');
    }

    $('exportBtn').addEventListener('click', exportPdf);
    $('calcBtn').addEventListener('click', compute);

    // ===================== i18n =====================
    function applyLang(lang){
      state.lang = lang;
      const s = I18N[lang] || I18N.ru;
      $('appTitle').innerText = s.appTitle || 'Calculator';
      $('addCurrent').innerText = s.add || '+ Add';
      $('addNew').innerText = s.add || '+ Add';
      $('clearCurrent').innerText = s.reset || 'Reset';
      $('clearNew').innerText = s.reset || 'Reset';
      $('calcBtn').innerText = s.calc || 'Calculate';
      $('exportBtn').innerText = s.export || 'Export';
      $('resetBtn').innerText = s.resetAll || 'Reset all';

      if (chart) {
        chart.data.labels = [s.chemistry, s.energy, s.water];
        chart.data.datasets[0].label = s.current;
        chart.data.datasets[1].label = s.new;
        chart.update();
      }

      saveState();
    }
    $('langSelect').addEventListener('change', ()=>{ applyLang($('langSelect').value); compute(); });

    // ===================== init =====================
    initUI(); renderTables(); compute();

    window.addEventListener('beforeunload', saveState);
  </script>
</body>
</html>
