<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Калькулятор экономии моющих средств</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #333; }
    h1 { color: #2c7be5; }
    .container { max-width: 1200px; margin: auto; }
    .section { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; }
    button { background: #2c7be5; color: #fff; padding: 10px 15px; border: none; border-radius: 6px; margin-top: 15px; cursor: pointer; }
    button:hover { background: #2364bb; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #2fcb7c; color: white; }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Калькулятор экономии моющих средств</h1>

  <div class="section">
    <h2>Общие параметры</h2>
    <label>Загрузка машины (кг): <input type="number" id="machineLoad" value="10"></label>
    <label>Тариф электроэнергии (₽/кВт·ч): <input type="number" id="energyTariff" value="5"></label>
    <label>Рабочих часов в день: <input type="number" id="workHours" value="9"></label>
  </div>

  <div class="section" id="currentDetergents">
    <h2>Текущие моющие средства</h2>
    <button onclick="addDetergent('current')">+ Добавить средство</button>
  </div>

  <div class="section" id="newDetergents">
    <h2>Наши новые средства</h2>
    <label>Температура новой программы (°C): <input type="number" id="newTemp" value="60"></label>
    <label>Время новой программы (мин): <input type="number" id="newTime" value="60"></label>
    <button onclick="addDetergent('new')">+ Добавить средство</button>
  </div>

  <div class="section">
    <h2>Результаты</h2>
    <table id="resultsTable">
      <thead>
        <tr>
          <th>Показатель</th>
          <th>Старые средства</th>
          <th>Новые средства</th>
          <th>Экономия</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="comparisonChart"></canvas>
    <button onclick="exportPDF()">Экспорт в PDF</button>
  </div>
</div>

<script>
let detergentCounters = { current: 0, new: 0 };

function addDetergent(type) {
  detergentCounters[type]++;
  const container = document.getElementById(type+"Detergents");
  const div = document.createElement("div");
  div.innerHTML = `
    <h3>${type === 'current' ? 'Текущее' : 'Новое'} средство ${detergentCounters[type]}</h3>
    <label>Название: <input type="text" class="${type}Name"></label>
    <label>Цена за литр (₽): <input type="number" class="${type}Price" value="100"></label>
    <label>Расход на 1 кг белья (мл/кг): <input type="number" class="${type}Consumption" value="30"></label>
  `;
  container.appendChild(div);
}

function calculate() {
  const machineLoad = parseFloat(document.getElementById("machineLoad").value);
  const energyTariff = parseFloat(document.getElementById("energyTariff").value);
  const workHours = parseFloat(document.getElementById("workHours").value);

  const oldDetergents = document.querySelectorAll(".currentName");
  let oldCost = 0;
  oldDetergents.forEach((el, i) => {
    const price = parseFloat(document.querySelectorAll(".currentPrice")[i].value);
    const cons = parseFloat(document.querySelectorAll(".currentConsumption")[i].value);
    oldCost += price * (cons/1000);
  });

  const newDetergents = document.querySelectorAll(".newName");
  let newCost = 0;
  newDetergents.forEach((el, i) => {
    const price = parseFloat(document.querySelectorAll(".newPrice")[i].value);
    const cons = parseFloat(document.querySelectorAll(".newConsumption")[i].value);
    newCost += price * (cons/1000);
  });

  const newTemp = parseFloat(document.getElementById("newTemp").value);
  const newTime = parseFloat(document.getElementById("newTime").value);

  const oldEnergy = (0.05*90 + 0.1*1) * energyTariff / machineLoad;
  const newEnergy = (0.05*newTemp + 0.1*(newTime/60)) * energyTariff / machineLoad;

  const oldTotal = oldCost + oldEnergy;
  const newTotal = newCost + newEnergy;

  const savings = oldTotal - newTotal;

  const tbody = document.querySelector("#resultsTable tbody");
  tbody.innerHTML = `
    <tr><td>Стоимость 1 кг стирки</td><td>${oldTotal.toFixed(2)}</td><td>${newTotal.toFixed(2)}</td><td>${savings.toFixed(2)}</td></tr>
  `;

  const ctx = document.getElementById('comparisonChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Химия', 'Энергия'],
      datasets: [
        { label: 'Старые', data: [oldCost, oldEnergy], backgroundColor: '#2c7be5' },
        { label: 'Новые', data: [newCost, newEnergy], backgroundColor: '#2fcb7c' }
      ]
    }
  });
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Отчет по экономии", 14, 16);
  doc.autoTable({ html: '#resultsTable', startY: 20 });
  doc.save("report.pdf");
}

setInterval(calculate, 2000);
</script>
</body>
</html>
